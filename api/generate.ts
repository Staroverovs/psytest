
import { GoogleGenAI } from "@google/genai";

export const config = {
  runtime: 'edge',
};

export default async function handler(req: Request) {
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), { status: 405 });
  }

  try {
    const { result, testDef } = await req.json();
    const apiKey = process.env.API_KEY || process.env.VITE_API_KEY;

    if (!apiKey) {
      return new Response(JSON.stringify({ error: 'API key not configured on server' }), { status: 500 });
    }

    const ai = new GoogleGenAI({ apiKey });
    
    const isDERS = testDef.id === 'ders-36';
    let scoresSummary = `–û–±—â–∏–π –±–∞–ª–ª: ${result.totalScore} –∏–∑ ${result.maxPossibleScore}.`;
    if (result.subscaleScores && Object.keys(result.subscaleScores).length > 0) {
      scoresSummary += "\n–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∞—Å–ø–µ–∫—Ç–∞–º:";
      for (const [subName, val] of Object.entries(result.subscaleScores)) {
        scoresSummary += `\n- ${subName}: ${val}`;
      }
    }

    const prompt = `
      –í—ã ‚Äî –≤–µ–¥—É—â–∏–π —ç–∫—Å–ø–µ—Ä—Ç-–ø—Å–∏—Ö–æ–ª–æ–≥ —Ü–µ–Ω—Ç—Ä–∞ ¬´–î–∏–∞–ª–µ–∫—Ç–∏–∫–∞¬ª. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ ¬´${testDef.title}¬ª.
      
      –î–ê–ù–ù–´–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
      ${scoresSummary}
      
      –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ö–û–ù–¢–ï–ù–¢–£:
      1. –ë—É–¥—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã. 
      2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ —à–∫–∞–ª—ã (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) –∑–∞–≤—ã—à–µ–Ω—ã, –∏ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π.
      3. –û–±—ä—è—Å–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É "–≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –º–µ—Ö–∞–Ω–∏–∫—É" –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è: –ø–æ—á–µ–º—É –æ–Ω –º–æ–∂–µ—Ç —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ, —á—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç, –∏—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–∏—Ö —Ü–∏—Ñ—Ä.
      4. –î–∞–π—Ç–µ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ–≤–µ—Ç–∞, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–º–µ–Ω–Ω–æ –ø–æ–¥ —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –±–∞–ª–ª–æ–≤.
      
      –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –û–§–û–†–ú–õ–ï–ù–ò–Æ (–î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•):
      1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Markdown. –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω—è ###.
      2. –ü–∏—à–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –∞–±–∑–∞—Ü–∞–º–∏ (–Ω–µ –±–æ–ª–µ–µ 3-4 —Å—Ç—Ä–æ–∫ –≤ –∞–±–∑–∞—Ü–µ).
      3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
      4. –°–¥–µ–ª–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.
      
      –°–¢–†–£–ö–¢–£–†–ê:
      ### üß≠ –ì–ª—É–±–∏–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      ### üß¨ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º
      ### üõ† –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏
      
      –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ù–ê–ß–ê–õ–û: "–Ø ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ü–µ–Ω—Ç—Ä–∞ ¬´–î–∏–∞–ª–µ–∫—Ç–∏–∫–∞¬ª. –û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö, —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–±–æ—Ä:"
      –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –§–ò–ù–ê–õ: "–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–æ–≤–æ–¥ –¥–ª—è –±–µ—Ä–µ–∂–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –∫ —Å–µ–±–µ. –î–ª—è –≥–ª—É–±–æ–∫–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–≥–ª–∞—à–∞–µ–º –≤–∞—Å –≤ —Ü–µ–Ω—Ç—Ä ¬´–î–∏–∞–ª–µ–∫—Ç–∏–∫–∞¬ª –∫ –Ω–∞—à–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º."
    `;

    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: prompt,
    });

    return new Response(JSON.stringify({ text: response.text }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error: any) {
    console.error("API Error:", error);
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
}
